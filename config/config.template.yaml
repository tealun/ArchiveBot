# ArchiveBot 配置模板
# 复制此文件为 config.yaml 并填写你的值

bot:
  token: BOT_TOKEN  # 从 @BotFather 获取（推荐使用环境变量 BOT_TOKEN）
  owner_id: OWNER_ID  # 你的 Telegram ID，从 @userinfobot 获取（推荐使用环境变量 OWNER_ID）
  language: "zh-CN"  # 界面语言: en, zh-CN, zh-TW, ja, ko, es
  polling_interval: 1  # 轮询间隔（秒）
  feedback_url: "https://github.com/tealun/ArchiveBot/issues"  # 用户反馈链接
  
  # 静默归档来源配置（这些来源的归档不会发送成功消息，并自动删除转发消息）
  # 支持频道ID和用户名两种匹配方式
  # 示例：[-1001234567890, -1009876543210, '@channel_username']
  # 环境变量：SILENT_SOURCES（支持JSON格式或逗号分隔）
  silent_sources: []

features:
  auto_tag: true  # 自动生成类型标签
  auto_file_type_tag: false  # 是否自动生成文件类型标签（如#图片、#视频等），默认false
  extract_tags_from_caption: false  # 从转发消息caption中提取#标签（默认关闭，避免标签污染）
  enable_fts: true  # 启用全文搜索
  enable_ocr: false  # 启用图片OCR识别

ai:
  enabled: true  # 启用AI功能
  auto_summarize: true  # 自动总结新归档内容
  auto_generate_tags: true  # 自动生成AI标签
  auto_generate_title: true  # 自动为笔记生成AI标题（15-20字）
  max_generated_tags: 8  # AI自动生成标签的最大数量（5-10为佳，默认8）
  min_content_length_for_summary: 150  # AI摘要的最小内容长度（字符数），低于此长度不生成摘要

  # 统一AI配置（推荐）。为避免硬编码密钥，建议通过环境变量设置API密钥
  # 并在 api.api_key_env 中引用环境变量名称
  api:
    provider: AI_API_PROVIDER  # 供应商: openai, claude, gemini, grok 等
    api_key_env: AI_API_KEY  # 环境变量名称（推荐使用）
    api_url: AI_API_URL  # 自定义API地址（可选，或使用环境变量 AI_API_URL）
    model: AI_MODEL  # 模型（或使用环境变量 AI_MODEL）
    reasoning_model: AI_REASONING_MODEL  # 用于意图分析的推理模型（或使用环境变量 AI_REASONING_MODEL）
    temperature: 0.7  # 生成多样性（0-1之间）
    max_tokens: 1000  # 最大token数
    timeout: 30  # 超时时间（秒）

  # 运行时控制和保护措施
  cache_enabled: true            # 启用AI响应缓存以避免重复调用和成本
  cache_path: "data/ai_cache.db" # 缓存数据库路径（sqlite）
  cache_ttl_seconds: 604800      # 缓存有效期（秒），默认7天
  rate_limit_per_minute: 60      # 全局每分钟API调用次数限制（启用请求队列后，可以设置更高的值如60-120，系统会自动排队避免触发API限制）
  log_calls: true                # 是否记录AI调用详情（便于调试，生产环境可设为false）
  retry_on_failure: 2            # 临时错误重试次数（建议2-3次，配合指数退避策略）
  auto_summary_on_forward: true  # 转发消息时自动触发摘要（处理器层级）
  auto_tagging: true             # 应用AI生成的标签（可设为false仅生成建议）
  
  # AI聊天模式（交互式对话）
  chat_enabled: false           # 启用短消息自动AI聊天模式
  chat_session_ttl_seconds: 600 # 会话超时时间（默认10分钟）
  chat_history_length: 10       # 会话历史保留消息对数（默认10，即20条消息）
  chat_allow_write_ops: false   # 允许AI执行写操作（归档/删除/标签）- 为安全起见保持false
  chat_use_reasoning: true      # 启用推理模型进行意图分析（默认启用）
  
  # 文本长度阈值配置（统一管理）
  text_thresholds:
    short_text: 50         # 短文本判断阈值（触发AI对话或意图询问）
    note_chinese: 150      # 中文笔记判断阈值(AI互动模式下用于区分长文本是否要做笔记还是继续对话)
    note_english: 250      # 英文笔记判断阈值(AI互动模式下用于区分长文本是否要做笔记还是继续对话)
  
  # AI参考内容排除配置（用于AI互动模式的上下文数据过滤）
  exclude_from_context:
    channel_ids: AI_EXCLUDE_CHANNELS  # 排除的存档频道ID列表，例如: [-1001234567890, -1009876543210]
    tags: AI_EXCLUDE_TAGS         # 排除的标签列表，例如: ['私密', '草稿', '临时', '不存档', 'exclude', 'skip']
    apply_to_ai_interactions: true  # 是否将排除规则应用于AI互动模式的统计与分析（true=完全隐藏，false=仅排除上下文样本）

logging:
  level: "INFO"  # 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
  file: "data/bot.log"  # 日志文件路径
  console: true  # 是否输出到控制台
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

storage:
  database:
    path: "data/archive.db"  # 数据库文件路径
  
  backup:
    auto_interval_hours: 168  # 自动备份间隔（小时），默认168小时（7天/每周）
    keep_count: 10           # 保留备份数量，默认保留最近10个
  
  telegram:
    enabled: true  # 启用Telegram存储
    # 向后兼容：旧的单频道配置（如果配置了channels.default则此项被忽略）
    channel_id: CHANNEL_DEFAULT  # 从环境变量读取
    
    # 多频道配置（推荐使用环境变量）
    channels:
      default: CHANNEL_DEFAULT  # 从环境变量读取（必填）
      text: CHANNEL_TEXT  # 从环境变量读取（可选）
      ebook: CHANNEL_EBOOK  # 从环境变量读取（可选）
      document: CHANNEL_DOCUMENT  # 从环境变量读取（可选）
      image: CHANNEL_IMAGE  # 从环境变量读取（可选）
      media: CHANNEL_MEDIA  # 从环境变量读取（可选）
      note: CHANNEL_NOTE  # 笔记专用频道，从环境变量读取（可选，未配置则使用text或default）
      featured: CHANNEL_FEATURED  # 精选存档专用频道，从环境变量读取（可选，未配置则精选功能仅修改数据库标记）
    
    # 类型到频道的映射规则
    type_mapping:
      text: text           # 纯文本 → 文本频道
      link: text           # 链接 → 文本频道
      note: text           # 笔记 → 文本频道（如果未配置note频道）
      ebook: ebook         # 电子书 → 电子书频道
      document: document   # 文档 → 文档频道
      image: image         # 图片 → 图片频道
      animation: image     # 动画GIF → 图片频道
      sticker: image       # 贴纸 → 图片频道
      video: media         # 视频 → 媒体频道
      audio: media         # 音频 → 媒体频道
      voice: media         # 语音 → 媒体频道
      contact: default     # 联系人 → 默认频道
      location: default    # 位置 → 默认频道

    # 来源到频道的映射配置（优先级高于类型映射）
    # 根据转发来源（频道/群组/用户）指定存储频道
    # 
    # 支持的来源类型：
    # 1. 频道 (Channel): 可用名称或ID匹配，如: '技术频道' 或 -1001234567890 或 1234567890
    # 2. 群组 (Group/Supergroup): 可用名称或ID匹配，如: '开发群组' 或 -1009876543210 或 9876543210
    # 3. 个人用户 (User): 仅用名称匹配（@username或显示名），如: 'JohnDoe' 或 '张三' 或 '@JohnDoe'
    # 4. 机器人 (Bot): 仅用名称匹配（@username），如: 'MyBot' 或 '@MyBot'
    # 5. 隐藏用户 (Hidden User): 用显示名称匹配，如: 'Deleted Account'
    #
    # ID格式说明：
    # - 可以使用完整ID（-1001234567890）或去掉-100前缀的简化ID（1234567890）
    # - 系统会自动处理-100前缀，无需担心格式问题
    # - 从Telegram客户端复制的ID通常不带-100前缀，可以直接使用
    #
    # 注意：
    # - 多个来源可以映射到同一个频道
    # - 一个来源不能映射到多个频道（取第一个匹配项）
    # - 用户ID不支持匹配（因为普通用户ID是正数，与频道/群组ID格式不同）
    # - 名称匹配区分大小写，建议使用ID以避免名称变更问题
    source_mapping:
      # 示例：
      # - sources: ['技术频道', '开发群组', 1234567890]  # 频道/群组：支持名称或ID（可不带-100前缀）
      #   channel_id: -1001111111111  # 目标存储频道（建议使用完整ID）
      # - sources: ['生活日常', -1009876543210, 'JohnDoe']  # 混合：名称 + 完整ID + 用户名
      #   channel_id: -1002222222222
      # - sources: ['MyBot', '@NewsBot']  # 机器人：支持带@或不带@
      #   channel_id: -1003333333333
    
    # 标签到频道的映射配置（优先级最高）
    # 根据消息标签指定存储频道
    # 多个标签可以映射到同一个频道，但一个标签不能映射到多个频道
    tag_mapping:
      # 示例：
      # - tags: ['工作', '项目', '任务']  # 多个标签映射到同一频道
      #   channel_id: -1001111111111
      # - tags: ['学习', '笔记']
      #   channel_id: -1002222222222
    
    # 个人直接发送内容的存储配置（无转发来源时）
    direct_send:
      # 个人直发的频道配置（可选，不配置则使用系统channels）
      channels:
        default: CHANNEL_DIRECT_DEFAULT  # 从环境变量读取（可选）
        # 其他频道可选配置：
        # text: CHANNEL_TEXT
        # ebook: CHANNEL_EBOOK
        # document: CHANNEL_DOCUMENT
        # image: CHANNEL_IMAGE
        # media: CHANNEL_MEDIA
      
      # 个人直发的类型映射规则（可选，不配置则使用系统type_mapping）
      type_mapping:
        # 示例（与系统type_mapping保持一致）：
        # text: text           # 纯文本 → 文本频道
        # link: text           # 链接 → 文本频道
        # ebook: ebook         # 电子书 → 电子书频道
        # document: document   # 文档 → 文档频道
        # image: image         # 图片 → 图片频道
        # animation: image     # 动画GIF → 图片频道
        # sticker: image       # 贴纸 → 图片频道
        # video: media         # 视频 → 媒体频道
        # audio: media         # 音频 → 媒体频道
        # voice: media         # 语音 → 媒体频道
        # contact: default     # 联系人 → 默认频道
        # location: default    # 位置 → 默认频道
  
  cloud:
    google_drive:
      enabled: false  # 启用Google Drive存储
      client_id: ""  # Google Drive客户端ID
      client_secret: ""  # Google Drive客户端密钥
      folder_name: "ArchiveBot"  # 存储文件夹名称
    
    aliyun:
      enabled: false  # 启用阿里云盘存储
      refresh_token: ""  # 阿里云盘刷新令牌
      folder_name: "归档"  # 存储文件夹名称
