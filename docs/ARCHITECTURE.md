# ArchiveBot 架构设计文档

> **面向对象**：二次开发者、技术人员、系统架构研究

本文档详细描述 ArchiveBot 的系统架构、技术选型、设计决策和实现细节。

## 1. 系统概述

### 1.1 核心定位

ArchiveBot 是一个**单用户**个人内容归档系统，通过 Telegram Bot 接口实现内容的智能分类、多级存储和高效检索。

**设计哲学**：
- **简单至上**：最简化架构，避免过度设计
- **单一职责**：每个模块职责清晰，易于维护
- **可扩展性**：模块化设计，易于添加新功能
- **性能优化**：WAL 模式、FTS5 索引、并发处理
- **AI增强**：智能提示词工程、多语言优化、内容语言自适应

### 1.2 技术选型理由

| 技术 | 选择理由 |
|------|---------|
| **Python 3.9+** | 简洁语法、丰富生态、异步支持 |
| **python-telegram-bot** | 成熟稳定、文档完善、社区活跃 |
| **SQLite** | 无需服务器、性能优秀、支持 FTS5 |
| **PyYAML** | 配置文件可读性好 |
| **asyncio** | 高效的异步I/O处理 || **httpx** | 轻量AI API调用（2MB vs 150MB SDK） |
### 1.3 架构演进

**第一版（简化策略）**：
- 移除了云盘存储的复杂逻辑
- 移除了本地 AI（Ollama）支持
- 采用纯 file_id 转发策略
- 存储频道消息的 file_id 而非用户消息 file_id

**第二版（消息框架统一）**：
- 引入 MessageBuilder 统一消息构建框架
- AI对话支持直接返回资源文件
- 全局列表展示格式统一
- 严格约束AI禁止虚构内容

**核心改进**：
```python
# 旧方案：下载 → 重新上传 → 存储
download_file() → upload_to_channel() → store_file_id()

# 新方案：直接转发 → 提取频道 file_id
forward_to_channel() → extract_channel_file_id()

# 消息框架：统一构建 → 复用格式
MessageBuilder.format_archive_list() → 搜索/标签/AI列表
MessageBuilder.send_archive_resource() → AI资源回复
```

## 2. 系统架构

### 2.1 整体架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     Telegram Bot API Layer                   │
│  ┌────────────────────────────────────────────────────┐      │
│  │  python-telegram-bot Framework                     │      │
│  │  • Application (Bot 实例)                          │      │
│  │  • CommandHandler (/start, /search, etc.)         │      │
│  │  • MessageHandler (文本、媒体消息)                  │      │
│  │  • CallbackQueryHandler (按钮回调)                 │      │
│  └────────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                       Bot Handlers Layer                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   commands   │  │   handlers   │  │  callbacks   │       │
│  │ • /start     │  │ • 消息处理    │  │ • 按钮响应    │       │
│  │ • /search    │  │ • 内容识别    │  │ • 确认对话    │       │
│  │ • /tags      │  │ • 转发处理    │  │ • AI对话     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     消息构建层（NEW）                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              MessageBuilder 统一框架                  │  │
│  │  • format_archive_list() - 列表格式化                │  │
│  │  • send_archive_resource() - 资源发送                │  │
│  │  复用于：搜索结果/标签列表/AI资源回复                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  内容分析     │  │  标签管理     │  │  搜索引擎     │      │
│  │  AI智能分析   │  │  批量操作     │  │  FTS5索引    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  AI对话路由   │  │  笔记管理     │  │  回收站      │      │
│  │  资源查询     │  │  导出/备份    │  │  精选收藏    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      存储管理层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              存储策略引擎                              │  │
│  │  • 根据文件大小选择存储方式（简化三级策略）           │  │
│  │  • Database → Telegram → Reference                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      存储层（简化版）                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ SQLite 数据库 │  │ Telegram频道  │  │ 引用信息      │      │
│  │ • 元数据      │  │ • 0-2GB文件   │  │ • >2GB记录   │      │
│  │ • 标签        │  │ • file_id转发 │  │ • 依赖原消息  │      │
│  │ • 全局配置    │  │ (私有频道)    │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 架构层次说明

#### Bot 交互层
- **作用**：用户与系统交互的唯一界面
- **功能**：
  - 接收用户发送的消息（文本、图片、视频、文档、转发等）
  - 处理命令（/start, /search, /tags 等）
  - 响应用户操作（内联按钮、确认对话）
  - 身份验证：只允许配置文件中指定的 owner_id 使用

#### 业务逻辑层
- **内容分析**：识别内容类型、提取关键信息
- **标签管理**：自动标签和手动标签、AI智能标签
- **搜索引擎**：FTS5全文搜索、标签搜索、时间范围搜索、分页展示
- **AI智能模块**：内容摘要、关键点提取、智能分类、标签生成

#### 存储管理层
- 根据规则选择存储方式
- 全局配额检查
- 存储失败重试机制

#### 存储层
- **SQLite 数据库**：元数据、标签、全局配置
- **Telegram 私有频道**：小文件存储（仅用于存储，不用于交互）
- **云端网盘**：大文件存储（使用 Bot 所有者授权的网盘）

## 3. 核心模块设计

### 3.1 内容分析模块

**功能**：识别和分析用户发送的内容

**输入**：Telegram 消息对象

**处理流程**：
1. 判断内容类型（文本/图片/视频/文档/链接等）
2. 提取元数据（文件名、大小、时间、来源等）
3. 分析内容（文本摘要、关键词提取、OCR等）
4. 生成初步标签建议

**输出**：结构化的内容对象

### 3.2 存储管理模块

**功能**：决定内容的存储方式和位置

**决策流程（简化版）**：

```
接收到文件
    ↓
获取文件大小和类型
    ↓
┌──────────────────────────┐
│ 文本/链接               │ → SQLite数据库
├──────────────────────────┤
│ 0-2GB媒体文件           │ → Telegram频道（file_id转发）
├──────────────────────────┤
│ >2GB文件                │ → 仅存引用信息（依赖原消息）
└──────────────────────────┘
    ↓
执行存储
    ↓
记录元数据到数据库
```

**优势**：
- 无需下载上传，直接file_id转发
- 频道消息file_id永久有效
- 简单可靠，无超时风险

### 3.3 标签管理模块

**功能**：为内容添加和管理标签

**标签来源**：
1. **自动标签**：根据内容类型自动生成（#图片、#视频、#文档）
2. **智能标签**：AI 分析内容生成（#技术、#学习、#旅游）
3. **手动标签**：用户自己添加的标签
4. **来源标签**：记录内容来源（#群组名、#频道名）

**标签结构**：
- 支持多级标签：`#工作/项目A/文档`
- 支持标签别名和合并
- 标签统计和热门标签

### 3.4 搜索引擎模块

**功能**：快速检索归档内容

**搜索方式**：
1. **关键词搜索**：在文件名、文本内容中搜索
2. **标签搜索**：按标签筛选
3. **类型搜索**：按文件类型筛选
4. **时间搜索**：按时间范围筛选
5. **来源搜索**：按来源群组/频道筛选
6. **组合搜索**：多条件组合
7. **AI数据搜索**：FTS5全文索引包含ai_summary和ai_category

**搜索优化**：
- 全文索引（SQLite FTS5）
- 搜索结果排序（相关度、时间）
- 搜索历史记录
- **分页展示**：10项/页，左右箭头导航
- **AI解析按钮**：标题预览 + 点击查看完整分析

### 3.5 笔记管理模块

**功能**：为归档内容添加笔记和批注

**核心能力**：
1. **独立笔记**：不关联任何归档的独立笔记
2. **关联笔记**：为特定归档添加笔记
3. **笔记模式**：快速进入笔记编辑状态
4. **笔记列表**：分页浏览所有笔记

**使用流程**：
```
方式1：进入笔记模式
/note → 发送笔记内容 → 自动保存

方式2：为归档添加笔记
选择归档 → 点击📝按钮 → 发送笔记内容

方式3：查看所有笔记
/notes → 分页浏览 → 点击查看详情
```

### 3.6 垃圾箱管理模块

**功能**：软删除和恢复机制

**核心能力**：
1. **软删除**：标记deleted=1，保留数据
2. **列表查看**：浏览已删除内容
3. **恢复功能**：从垃圾箱恢复
4. **永久删除**：物理删除数据
5. **批量操作**：清空垃圾箱

**数据保护**：
- 软删除不影响存储文件
- 删除时间记录（deleted_at）
- 可配置自动清理策略（30天）

### 3.7 导出管理模块

**功能**：多格式数据导出

**支持格式**：
1. **JSON**：完整数据结构
2. **Markdown**：可读性强，支持标签统计
3. **HTML**：带样式，可直接打开

**导出策略**：
- 打包为ZIP文件
- 包含元数据和统计信息
- 标签关联保留
- 支持筛选导出

### 3.8 备份管理模块

**功能**：数据库备份和恢复

**核心能力**：
1. **手动备份**：即时创建完整备份
2. **备份列表**：查看历史备份记录
3. **一键恢复**：从备份恢复数据库
4. **备份清理**：删除旧备份释放空间

**备份策略**：
- 完整数据库拷贝
- 时间戳命名
- 元数据记录（大小、时间、统计）
- 待实现：自动调度、增量备份

### 3.9 回顾管理模块

**功能**：内容回顾和统计分析

**核心能力**：
1. **随机回顾**：随机展示历史归档
2. **活动概要**：日/周/月活跃度统计
3. **趋势分析**：热门标签和活动图表
4. **统计报告**：生成格式化报告

**统计维度**：
- 时间分布（按天/周/月）
- 类型分布
- 标签热度
- 存储占用

### 3.10 AI智能模块

**功能**：智能内容分析和组织

**核心能力**：
1. **内容摘要**：30-100字精简摘要
2. **关键点提取**：3-5个核心观点
3. **智能分类**：自动分类到适合的category
4. **标签生成**：5个精准可搜索的标签

**提示词工程**：
```
① 角色扮演
  └─ 信息管理员 + 知识组织专家
  
② 上下文信息
  ├─ 文件类型/大小/扩展名
  ├─ 已有标签（去重）
  ├─ 标题信息
  ├─ 内容语言检测
  └─ 分析深度策略
  
③ Few-Shot示例
  └─ 华尔街之狼电影示例
  
④ 输出质量约束
  ├─ 摘要长度限制
  ├─ 关键点规范
  ├─ 单一分类原则
  └─ 标签精准度要求
  
⑤ 思维链
  └─ 4步分析流程
  
⑥ 内容语言检测
  └─ 自动识别 zh/en/mixed
  
⑦ 智能降级策略
  ├─ minimal: <50字符
  ├─ brief: 50-200字符
  └─ full: >=200字符
```

**多语言优化**：
- **简体中文**：文档、教程、视频、照片
- **繁体中文**：文件、教學、影片、相片
- **英文**：完整优化的专业术语

**API支持**：
- Grok-4 (xAI) - 当前使用
- OpenAI GPT-4/3.5
- Anthropic Claude
- 阿里云通义千问

### 3.11 AI对话路由模块

**功能**：智能对话和资源查询

**核心流程**：
```
用户消息 → AI理解意图 → 规划响应策略 → 数据收集 → 生成回复/发送资源
```

**三阶段处理**：
1. **理解阶段**：AI分析用户需求和问题类型
2. **数据收集**：根据规划查询统计/搜索/资源
3. **响应生成**：文本回复或资源回复

**响应策略**：
- `direct_answer` - 直接文本回答
- `data_analysis` - 数据分析报告
- `search_results` - 搜索结果展示
- `resource_reply` - 直接返回文件资源（NEW）
- `clarify` - 澄清询问

**资源查询能力**：
- **随机查询**：随机抽取符合条件的文件
- **搜索查询**：根据关键词搜索文件
- **筛选查询**：按标签/类型/精选筛选

**严格约束**：
- 绝对禁止虚构URL、文件名、file_id
- 查询不到结果时如实告知
- 需要返回文件时必须使用resource_reply策略

### 3.12 MessageBuilder 消息构建框架

**功能**：统一的消息格式化和资源发送

**设计理念**：
- **单一职责**：专注消息构建，不处理业务逻辑
- **全局复用**：所有列表展示统一格式
- **参数化配置**：支持灵活定制

**核心方法**：

#### format_archive_list()
```python
格式化归档列表 - 统一所有列表展示格式

参数：
  archives: 归档列表
  i18n: 国际化对象
  db_instance: 数据库实例（查询精选/笔记状态）
  with_links: 是否生成Telegram跳转链接

返回：
  格式化的HTML文本

应用场景：
  • 搜索结果列表
  • 标签下归档列表
  • AI返回的多资源列表
  • 回顾/随机查看列表
```

#### send_archive_resource()
```python
发送归档资源文件

参数：
  bot: Telegram Bot实例
  chat_id: 接收者ID
  archive: 归档记录（含storage_path等）
  caption: 可选说明文字

处理流程：
  1. 验证storage_type为telegram
  2. 解析storage_path提取file_id
  3. 根据content_type选择发送方法
     - photo → send_photo
     - video → send_video  
     - document → send_document
     - audio → send_audio
     - voice → send_voice
  4. 异常处理和日志记录

返回：
  发送的消息对象或None
```

**统一列表格式**：
```
序号. 📄 [标题链接]
   #标签1 #标签2
   ❤️ 已精选 | 📝 √ 有笔记 | 📅 2026-01-24
---------------------
序号. 🖼️ [标题链接]
   #标签3
   🤍 未精选 | 📝 无笔记 | 📅 2026-01-23
```

**架构优势**：
- 代码复用率提升120行+
- 格式修改只需改一处
- 降低维护成本
- 保证一致性

## 4. 数据模型

### 4.1 核心数据表

#### archives（归档内容表）
- id：主键
- content_type：内容类型（text/image/video/document/link）
- title：标题/文件名
- content：文本内容（文本消息）
- file_id：Telegram file_id
- storage_type：存储类型（database/telegram/cloud/reference）
- storage_provider：存储提供商（google_drive/aliyun等）
- storage_path：存储路径/ID
- file_size：文件大小
- metadata：元数据（JSON）
- source：来源（频道/群组）
- **favorite**：精选标记（0/1）
- **deleted**：软删除标记（0/1）
- **deleted_at**：删除时间
- **ai_summary**：AI生成的摘要（FTS5索引）
- **ai_key_points**：AI提取的关键点（JSON）
- **ai_category**：AI分类（FTS5索引）
- created_at：创建时间
- archived_at：归档时间

#### tags（标签表）
- id：主键
- tag_name：标签名称
- tag_type：标签类型（auto/ai/manual）
- parent_tag_id：父标签 ID（支持多级标签）
- count：使用次数
- created_at：创建时间

#### archive_tags（归档-标签关联表）
- archive_id：归档 ID
- tag_id：标签 ID

#### notes（笔记表）
- id：主键
- archive_id：关联归档ID（NULL表示独立笔记）
- content：笔记内容
- created_at：创建时间

#### config（全局配置表）
- key：配置项键名
- value：配置值
- description：说明
- updated_at：更新时间

#### storage_stats（存储统计表）
- storage_type：存储类型
- provider：提供商
- used_size：已使用大小
- file_count：文件数量
- updated_at：更新时间

## 5. 数据流程

### 5.1 归档流程

```
用户发送内容
    ↓
Bot 接收消息
    ↓
验证所有者身份
    ↓
内容分析模块
  • 识别类型
  • 提取元数据
  • 生成标签建议
    ↓
存储策略决策
  • 根据大小选择存储
  • 检查全局配额
  • 选择网盘（如有多个）
    ↓
执行存储
  • 上传到对应位置
  • 记录存储信息
    ↓
更新数据库
  • 保存元数据
  • 关联标签
  • 更新统计
    ↓
返回用户确认
  • 归档成功提示
  • 标签展示
  • 存储位置说明
```

### 5.2 搜索流程

```
用户输入搜索条件
    ↓
解析搜索语法
  • 关键词
  • 标签
  • 时间范围
  • 内容类型
    ↓
构建查询
  • 数据库查询
  • 全文索引搜索 (FTS5)
  • 包含AI字段 (ai_summary, ai_category)
  • 统计总数
    ↓
结果排序
  • 相关度排序
  • 时间排序
    ↓
分页处理
  • 10项/页
  • LIMIT/OFFSET计算
  • 总页数计算
    ↓
返回结果
  • 格式化展示
  • AI解析按钮（🤖 #N《标题预览》）
  • 导航按钮（⬅️ 上一页 | 📄 1/3 | ➡️ 下一页）
  • 点击标题跳转频道消息
```

### 5.3 配置网盘流程

```
编辑配置文件/使用命令
    ↓
选择网盘类型
    ↓
生成授权链接
    ↓
在浏览器授权
    ↓
获取授权码
    ↓
交换 access_token
    ↓
测试连接
  • 创建测试文件夹
  • 检查权限
  • 获取配额信息
    ↓
保存配置
    ↓
设置为可用状态
```

## 6. 存储策略详解

### 6.1 三级存储架构

#### 第一级：数据库存储（热数据）
- **存储内容**：文本消息、链接、元数据
- **特点**：快速读写、全文搜索、结构化
- **适用**：频繁查询的数据

#### 第二级：Telegram 频道存储（温数据）
- **存储内容**：小文件（<10MB）、图片
- **特点**：永久免费、可靠、访问快速
- **实现**：创建私有频道，Bot 发送文件到频道

#### 第三级：云端网盘存储（冷数据）
- **存储内容**：大文件（>10MB）
- **特点**：大容量、成本可控
- **策略**：轮询或优先级分配

#### 兜底方案：仅存引用
- **存储内容**：超大文件（>500MB）的 file_id
- **特点**：不占空间，但依赖原消息
- **风险**：原消息删除后失效

### 6.2 网盘选择策略

#### 策略1：用户指定
用户在配置中指定首选网盘，所有大文件都存到该网盘

#### 策略2：轮询分配
多个网盘轮流使用，均衡负载

#### 策略3：智能分配
- 根据文件类型选择（视频→阿里云盘，文档→Google Drive）
- 根据剩余空间选择（优先使用空间充足的）
- 根据地理位置选择（国内用户→阿里云盘）

### 6.3 文件大小阈值配置

```yaml
storage_rules:
  # 规则1：文本和链接
  - content_types: [text, link]
    storage: database
    
  # 规则2：小文件
  - size_max: 10MB
    storage: telegram_channel
    
  # 规则3：中等文件
  - size_min: 10MB
    size_max: 100MB
    storage: cloud_drive
    auto_confirm: true
    
  # 规则4：大文件（需确认）
  - size_min: 100MB
    size_max: 500MB
    storage: cloud_drive
    require_confirm: true
    warning: "该文件较大，将占用网盘空间"
    
  # 规则5：超大文件
  - size_min: 500MB
    storage: file_id_only
    warning: "文件过大，仅保存引用，原消息删除后将无法访问"
```

## 7. 开发阶段规划

### MVP (v0.1) - 2-3周

**目标**：实现基础归档功能，自己能用

**核心功能**：
- ✅ Bot 基础框架搭建
- ✅ 所有者身份验证
- ✅ 接收和识别内容类型
- ✅ 文本/链接存入数据库
- ✅ 简单的标签系统
- ✅ 基础搜索功能（关键词）
- ✅ Telegram 频道存储（小文件）

**不包含**：
- ❌ 云端网盘集成
- ❌ AI 智能标签
- ❌ 复杂搜索
- ❌ Web 界面

---

### v1.0 - 1-2个月 ✅ 大部分完成

**目标**：完善存储系统，提升实用性

**已完成功能**：

**用户体验**：
- ✅ 快速笔记和批注（/note、/notes、笔记模式）
- ✅ 精选收藏功能（favorite字段、❤️按钮）
- ✅ 快速转发功能（↗️按钮）
- ✅ 批量操作（标签批量移除/替换核心层完成）
- 🚧 快捷命令和别名
- 🚧 交互式配置向导

**数据管理**：
- ✅ 垃圾箱机制（软删除、恢复、永久删除）
- ✅ 数据导出（JSON/Markdown/HTML）
- ✅ 备份功能（创建/列表/恢复/删除）
- ✅ 回顾统计（核心层完成，待命令对接）
- 🚧 自动备份调度
- 🚧 增量备份算法

**待完成功能**：

**存储相关**：
- ⏳ Google Drive / 阿里云盘集成
- ⏳ 多级存储策略
- ⏳ 存储统计和可视化
- ⏳ 智能去重（MD5/内容相似度）

---

### v1.5 - 2-3个月

**目标**：AI 赋能，智能化升级

**新增功能**：

**AI 功能**：
- 智能摘要生成（AI API）
- OCR 和内容提取
- 自动分类和整理
- 翻译功能

**数据增强**：
- 关联和引用系统
- 版本管理
- 高级筛选和视图
- 数据分析面板

**性能优化**：
- 缓存优化
- 异步处理优化

---

### v2.0 - 长期迭代

**目标**：多端协作，知识网络

**核心特性**：

**知识管理**：
- 智能问答（RAG）
- 知识图谱可视化
- 归档模板系统
- 时光机（年度报告、回忆模式）

**集成扩展**：
- Web 管理界面
- 浏览器扩展
- RSS 订阅
- 社交媒体同步（Twitter、GitHub、YouTube）

**高级功能**：
- 内容监控
- 游戏化（成就、连续记录）
- 加密功能
- 主题和个性化

---

### v3.0+ - 未来探索

**目标**：生态系统，极致体验

**可能方向**：
- 分布式存储
- 更多 AI 模型支持
- 插件市场
- 移动端 APP
- 多用户协作（可选）
- 审计日志和异常检测

## 8. 关键技术决策

### 8.1 为什么选择 SQLite？

**优点**：
- 轻量级，无需独立数据库服务
- 支持全文搜索（FTS5）
- 部署简单，适合个人使用
- 性能足够（百万级数据无压力）

**局限**：
- 不支持高并发（但个人 Bot 不需要）
- 需要定期备份

**扩展方案**：
- 高级用户可选 PostgreSQL

### 8.2 为什么使用 Telegram 频道作为存储？

**优点**：
- 完全免费
- 无限存储空间（小文件）
- 访问速度快
- 不需要维护服务器
- 文件永久保存

**实现**：
- 创建一个私有频道
- Bot 作为管理员
- 用户看不到这个频道
- 通过 message_id 访问文件

### 8.3 为什么支持多网盘？

**理由**：
- 不同用户有不同偏好
- 免费额度有限，多网盘增加配额
- 降低单一服务风险
- 地域差异（国内外访问速度）

**实现难点**：
- 需要维护多个网盘的 SDK
- 授权流程不统一
- API 限流和错误处理

## 9. 安全和隐私

### 9.1 数据安全

- 数据库本地存储，完全掌控
- 网盘使用自己的账号，不经过第三方
- Bot Token 和网盘 Token 本地加密存储
- 支持数据导出和备份

### 9.2 隐私保护

- Bot 仅限所有者使用，数据不共享
- 所有数据本地处理，不上传第三方服务器
- AI 功能可选（本地或自己的 API Key）
- 开源代码，透明可审计

### 9.3 身份验证

```python
# 简单的所有者验证
OWNER_ID = config['bot']['owner_id']

async def verify_owner(update: Update) -> bool:
    return update.effective_user.id == OWNER_ID
```

## 10. 配置管理

### 10.1 全局配置

```yaml
# config/config.yaml

bot:
  token: "YOUR_BOT_TOKEN"
  owner_id: 123456789  # Bot 所有者的 Telegram ID

storage:
  telegram:
    channel_id: -1001234567890
    
  database:
    path: "data/archive.db"
    
  cloud:
    # Google Drive 配置
    google_drive:
      enabled: false
      client_id: ""
      client_secret: ""
      folder_name: "ArchiveBot"
      
    # 阿里云盘配置
    aliyun:
      enabled: false
      refresh_token: ""
      folder_name: "归档"

limits:
  max_file_size: 200MB        # 最大文件大小
  total_quota: 10GB           # 总配额限制
  small_file_threshold: 10MB  # Telegram 频道阈值
  large_file_threshold: 500MB # 仅存引用阈值
  confirm_threshold: 100MB    # 需要确认的阈值
  
features:
  enable_ai_tags: false  # AI 智能标签
  enable_ocr: false      # OCR 识别
  auto_tag: true         # 自动类型标签
  
search:
  enable_fts: true       # 全文搜索
  results_per_page: 10   # 每页结果数
```

## 11. 扩展性设计

### 11.1 插件系统

预留插件接口，方便后续扩展：
- 内容处理插件（OCR、翻译、摘要）
- 存储提供商插件（新网盘）
- 搜索引擎插件（Elasticsearch）
- 导出格式插件（Markdown、PDF）

### 11.2 API 接口

为未来的 Web/移动端预留 API：
- RESTful API
- GraphQL（可选）
- Webhook 通知

## 12. 性能优化

### 12.1 异步处理

- 文件上传异步进行
- 大文件上传显示进度
- 后台任务队列

### 12.2 缓存策略

- 热门搜索结果缓存
- 标签列表缓存
- 用户配置缓存

### 12.3 数据库优化

- 合适的索引
- 定期清理日志
- 数据库备份策略

## 13. 监控和日志

### 13.1 日志记录

- 操作日志（用户行为）
- 错误日志（异常和失败）
- 性能日志（响应时间）

### 13.2 监控指标

- 归档内容数量
- 存储使用情况
- 错误率和成功率

## 14. 部署方案

### 14.1 本地部署（推荐）

- 在自己电脑上运行（Windows/Mac/Linux）
- 数据完全本地化
- 适合个人使用
- 简单可靠

### 14.2 VPS 部署

- 部署到云服务器
- 24/7 在线
- 远程访问数据
- 需要考虑成本

### 14.3 Docker 部署

- 提供 Dockerfile
- 一键部署
- 环境隔离
- 易于迁移

---

## 总结

ArchiveBot 采用模块化、分层的架构设计，通过智能的多级存储策略，在成本、性能和可靠性之间取得平衡。系统设计简单易用，同时保留了足够的扩展空间，可以根据用户需求逐步完善功能。
